name: Auto-update Claude Code

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ‡ÐµÑ€ÐµÐ· GitHub UI

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°

      - name: Get current Claude Code version from lockfile
        id: current_version
        run: |
          CURRENT_VERSION=$(jq -r '.claudeCodeVersion' .nvm-isolated-lockfile.json)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version in lockfile: $CURRENT_VERSION"

      - name: Get current sandbox-runtime version from lockfile
        id: current_sandbox_version
        run: |
          CURRENT_SANDBOX=$(jq -r '.sandboxRuntimeVersion // "not installed"' .nvm-isolated-lockfile.json)
          echo "current=$CURRENT_SANDBOX" >> $GITHUB_OUTPUT
          echo "Current sandbox-runtime in lockfile: $CURRENT_SANDBOX"

      - name: Get latest Claude Code version from npm
        id: latest_version
        run: |
          LATEST_VERSION=$(npm view @anthropic-ai/claude-code version 2>/dev/null || echo "unknown")
          echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest version on npm: $LATEST_VERSION"

      - name: Get latest sandbox-runtime version from npm
        id: latest_sandbox_version
        run: |
          LATEST_SANDBOX=$(npm view @anthropic-ai/sandbox-runtime version 2>/dev/null || echo "unknown")
          echo "latest=$LATEST_SANDBOX" >> $GITHUB_OUTPUT
          echo "Latest sandbox-runtime on npm: $LATEST_SANDBOX"

      - name: Compare versions
        id: compare
        run: |
          # Normalize version string (remove 'v' prefix, extract X.Y.Z)
          normalize_version() {
            local ver="$1"
            # Remove 'v' prefix if present
            ver="${ver#v}"
            # Extract version pattern X.Y.Z
            echo "$ver" | grep -oP '\d+\.\d+\.\d+' | head -1 || echo "$ver"
          }

          CURRENT="$(normalize_version '${{ steps.current_version.outputs.current }}')"
          LATEST="$(normalize_version '${{ steps.latest_version.outputs.latest }}')"
          CURRENT_SANDBOX="$(normalize_version '${{ steps.current_sandbox_version.outputs.current }}')"
          LATEST_SANDBOX="$(normalize_version '${{ steps.latest_sandbox_version.outputs.latest }}')"

          NEEDS_UPDATE=false

          # Check Claude Code update
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "ðŸ”„ Claude Code update available: $CURRENT â†’ $LATEST"
            NEEDS_UPDATE=true
          else
            echo "âœ… Claude Code up to date ($CURRENT)"
          fi

          # Check sandbox-runtime update
          if [ "$CURRENT_SANDBOX" != "not installed" ] && [ "$CURRENT_SANDBOX" != "$LATEST_SANDBOX" ]; then
            echo "ðŸ”„ Sandbox-runtime update available: $CURRENT_SANDBOX â†’ $LATEST_SANDBOX"
            NEEDS_UPDATE=true
          else
            if [ "$CURRENT_SANDBOX" = "not installed" ]; then
              echo "â„¹ï¸  Sandbox-runtime not installed"
            else
              echo "âœ… Sandbox-runtime up to date ($CURRENT_SANDBOX)"
            fi
          fi

          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT

      - name: Setup isolated environment
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÑÑ€ÐµÐ´Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
          ./iclaude.sh --check-isolated || {
            echo "âŒ Isolated environment check failed"
            exit 1
          }

      - name: Check sandbox dependencies
        if: steps.compare.outputs.needs_update == 'true'
        id: sandbox_check
        run: |
          echo "ðŸ” Checking sandbox dependencies..."
          ./iclaude.sh --sandbox-check

          # Check if sandbox is available in lockfile
          SANDBOX_AVAILABLE=$(jq -r '.sandboxAvailable // false' .nvm-isolated-lockfile.json)
          echo "sandbox_available=$SANDBOX_AVAILABLE" >> $GITHUB_OUTPUT

          if [ "$SANDBOX_AVAILABLE" = "true" ]; then
            echo "âœ… Sandbox dependencies configured"
          else
            echo "â„¹ï¸  Sandbox not configured in this environment"
          fi

      - name: Update Claude Code
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          echo "ðŸ”„ Updating Claude Code..."
          echo "Current: ${{ steps.current_version.outputs.current }}"
          echo "Latest:  ${{ steps.latest_version.outputs.latest }}"

          # Check if update is actually needed
          if [ "${{ steps.current_version.outputs.current }}" = "${{ steps.latest_version.outputs.latest }}" ]; then
            echo "â„¹ï¸  Already on latest version, skipping update"
            exit 0
          fi

          # Use iclaude.sh wrapper which handles all environment setup
          if ./iclaude.sh --update; then
            echo "âœ… Claude Code updated successfully"
          else
            echo "âŒ Update failed, but continuing..."
          fi

          # Verify update
          NEW_VERSION=$(jq -r '.claudeCodeVersion' .nvm-isolated-lockfile.json)
          echo "Version in lockfile: $NEW_VERSION"

      - name: Update sandbox dependencies
        if: steps.compare.outputs.needs_update == 'true' && steps.sandbox_check.outputs.sandbox_available == 'true'
        run: |
          CURRENT_SANDBOX="${{ steps.current_sandbox_version.outputs.current }}"
          LATEST_SANDBOX="${{ steps.latest_sandbox_version.outputs.latest }}"

          if [ "$CURRENT_SANDBOX" != "$LATEST_SANDBOX" ]; then
            echo "ðŸ”„ Updating sandbox-runtime: $CURRENT_SANDBOX â†’ $LATEST_SANDBOX"

            # Install system dependencies (bubblewrap, socat) if needed
            if ! command -v bwrap &>/dev/null || ! command -v socat &>/dev/null; then
              echo "ðŸ“¦ Installing system dependencies..."
              sudo apt-get update -qq
              sudo apt-get install -y bubblewrap socat
            fi

            # Update sandbox-runtime npm package via iclaude.sh wrapper
            # (wrapper handles NVM environment setup automatically)
            export NVM_DIR="$PWD/.nvm-isolated"
            export NPM_CONFIG_PREFIX="$NVM_DIR/npm-global"
            source "$NVM_DIR/nvm.sh"

            # Get Node version and use it
            NODE_VERSION=$(jq -r '.nodeVersion' .nvm-isolated-lockfile.json)
            nvm use "$NODE_VERSION"

            # Add npm-global to PATH
            export PATH="$NPM_CONFIG_PREFIX/bin:$PATH"

            # Update package
            npm install -g @anthropic-ai/sandbox-runtime@latest

            # Update lockfile
            ./iclaude.sh --check-isolated > /dev/null 2>&1 || true

            NEW_SANDBOX_VERSION=$(jq -r '.sandboxRuntimeVersion' .nvm-isolated-lockfile.json)
            echo "âœ… Updated sandbox-runtime to: $NEW_SANDBOX_VERSION"
          else
            echo "âœ… Sandbox-runtime already up to date ($CURRENT_SANDBOX)"
          fi

      - name: Check for changes
        if: steps.compare.outputs.needs_update == 'true'
        id: check_changes
        run: |
          # Check for changes in Claude Code and sandbox-runtime
          CHANGED_FILES=""

          if ! git diff --quiet .nvm-isolated-lockfile.json; then
            CHANGED_FILES="$CHANGED_FILES lockfile"
          fi

          if ! git diff --quiet .nvm-isolated/npm-global/lib/node_modules/@anthropic-ai/claude-code/; then
            CHANGED_FILES="$CHANGED_FILES claude-code"
          fi

          if [ -d ".nvm-isolated/npm-global/lib/node_modules/@anthropic-ai/sandbox-runtime/" ]; then
            if ! git diff --quiet .nvm-isolated/npm-global/lib/node_modules/@anthropic-ai/sandbox-runtime/; then
              CHANGED_FILES="$CHANGED_FILES sandbox-runtime"
            fi
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No changes detected after update"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected:$CHANGED_FILES"
          fi

      - name: Commit and push changes
        if: steps.compare.outputs.needs_update == 'true' && steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          NEW_VERSION="${{ steps.latest_version.outputs.latest }}"
          NEW_SANDBOX_VERSION="${{ steps.latest_sandbox_version.outputs.latest }}"
          CURRENT_SANDBOX="${{ steps.current_sandbox_version.outputs.current }}"

          # Add all changed @anthropic-ai packages
          git add .nvm-isolated-lockfile.json
          git add .nvm-isolated/npm-global/lib/node_modules/@anthropic-ai/claude-code/

          # Add sandbox-runtime if it exists and was updated
          if [ -d ".nvm-isolated/npm-global/lib/node_modules/@anthropic-ai/sandbox-runtime/" ]; then
            git add .nvm-isolated/npm-global/lib/node_modules/@anthropic-ai/sandbox-runtime/
            git add .nvm-isolated/npm-global/bin/srt
          fi

          # Build commit message
          COMMIT_MSG="chore(deps): auto-update Claude Code"
          COMMIT_DETAILS="Automated update via GitHub Actions"

          # Add Claude Code version info
          COMMIT_DETAILS="${COMMIT_DETAILS}\n\nClaude Code: ${{ steps.current_version.outputs.current }} â†’ ${NEW_VERSION}"

          # Add sandbox-runtime info if updated
          if [ "$CURRENT_SANDBOX" != "not installed" ] && [ "$CURRENT_SANDBOX" != "$NEW_SANDBOX_VERSION" ]; then
            COMMIT_MSG="${COMMIT_MSG} + sandbox-runtime"
            COMMIT_DETAILS="${COMMIT_DETAILS}\nSandbox-runtime: ${CURRENT_SANDBOX} â†’ ${NEW_SANDBOX_VERSION}"
          fi

          COMMIT_MSG="${COMMIT_MSG} [skip ci]"

          git commit -m "$COMMIT_MSG" -m "$COMMIT_DETAILS"
          git push origin master

          echo "âœ… Successfully updated and pushed changes"

      - name: Summary
        if: always()
        run: |
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Claude Code" >> $GITHUB_STEP_SUMMARY
          echo "- **Current version:** ${{ steps.current_version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest version:** ${{ steps.latest_version.outputs.latest }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sandbox Runtime" >> $GITHUB_STEP_SUMMARY
          echo "- **Current version:** ${{ steps.current_sandbox_version.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest version:** ${{ steps.latest_sandbox_version.outputs.latest }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Update needed:** ${{ steps.compare.outputs.needs_update }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.compare.outputs.needs_update }}" = "true" ]; then
            if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
              echo "- **Result:** âœ… Updated successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Result:** âš ï¸  Update attempted but no changes" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Result:** âœ… Already up to date" >> $GITHUB_STEP_SUMMARY
          fi
